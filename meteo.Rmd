---
title: "Mémoire - MAP565 Time series analysis - Étude type séries temporelles"
author: ""
output:
  html_document:
    number_sections: yes
    toc: yes
  pdf_document:
    toc: yes
---

# Début
On commence pour télécharger les données dans R et les visualiser.
```{r echo=FALSE}
m <- read.csv("data/925867.csv")
ts <- ts(m[4], start=c(1997,03,19), end=c(2017,03,19),frequency=365)
plot(ts,axes = FALSE, ann=FALSE)
S=seq(2000, to = 2015, by = 5)
axis(1, at = c(1997, S, 2017))
title(xlab = "Années")
axis(2, at = seq(from = -5, to = 30, by = 5))
title(main = "Températures moyennes journalières à Toulouse", font.main=1)
title(ylab = "Température")
box()
```


-----


# Trend et saisonnalité

On décompose avec une méthode par régression (STL) et une autre par moyenne mobiles en partie trend, saisonnalité et la composante aléatoire résiduelle.

## Décomposition STL
```{r echo=FALSE}
loess <- stl(ts, s.window = "periodic")
plot(loess)
```


## Décomposition par moyenne mobile
```{r echo=FALSE}
madd <- decompose(ts, type = "additive", filter = NULL)
plot(madd)
```

-----

# Analyse des fonctions d'autocorrélation, d'autocovariance et d'autocorrélation partielle

**Série originale**   

```{r echo=FALSE}
cor = acf(ts, type = "correlation", plot = FALSE)
cov = acf(ts, type = "covariance", plot = FALSE)
par = acf(ts, type = "partial", plot = FALSE)
plot(cor)
plot(cov)
plot(par)
```

**Après décomposition STL**  

```{r echo=FALSE}
rmd <- loess$time.series[,3]
cor <- acf(rmd, type = "correlation", plot = FALSE)
cov <- acf(rmd, type = "covariance", plot = FALSE)
par <- acf(rmd, type = "partial", plot = FALSE)
plot(cor)
plot(cov)
plot(par)
```

-----

# Estimation ARMA/ARIMA

## Identification a priori
En plusieurs étapes :  
  * Enlever un trend et une sasonnalité deterministes et rendre le processus stationnaire.
  * Déterminer les possibles (p,d,q), en pratique on détermine les plus grandes valeurs possibles pour p et q.  

L'autocorrelation de la série originale décroît lentement, mais après décomposition STL, la fonction AC décroît exponentiellement vite.

* Pour lag > p, on a AC partielle = 0.  

* Pour lag > q, AC = 0.

On fixe donc, après l'analyse des graphiques :
```{r}
pmax <- 2
qmax <- 10
```



## Estimation
On doit :
* Estimer des paramètres phi, theta, mu, sigma2
* Faire décroître p et q jusqu'à ce qu'il n'y ait que des paramètres significatifs.

On commence avec pmax et qmax :

* Modèle 1 : (p,q) = (2,10), ma10 et ar2 ne sont pas significatifs.
```{r echo=FALSE, eval=FALSE}
mod1 <- arima(rmd, order= c(pmax,0,qmax))
mod1
```


* Modèle 2 : (p,q) = (2,9), ma9 et ar2 ne sont pas significatifs.  
```{r echo=FALSE, eval=FALSE}
mod2 <- arima(rmd, order= c(pmax,0,qmax-1))
mod2
```


* Modèle 3 : (p,q) = (1,10), ma10 n'est pas significatif.
```{r echo=FALSE, eval=FALSE}
mod3 <- arima(rmd, order= c(pmax-1,0,qmax))
mod3
``` 
    


* Modèle 4 : (p,q) = (1,9), ma9 n'est pas significatif.  
```{r echo=FALSE, eval=FALSE}
mod4 <- arima(rmd, order= c(pmax-1,0,qmax-1))
mod4
```


* Modèle 5 : (p,q) = (1,8), ma8 n'est pas significatif.  
```{r echo=FALSE, eval=FALSE}
mod5 <- arima(rmd, order= c(pmax-1,0,qmax-2))
mod5
```


* Modèle 6 : (p,q) = (1,7), ma7 n'est pas significatif.  
```{r echo=FALSE, eval=FALSE}
mod6 <- arima(rmd, order= c(pmax-1,0,qmax-3))
mod6
```


* Modèle 7 : (p,q) = (1,6), ma6 n'est pas significatif.
```{r echo=FALSE, eval=FALSE}
mod7 <- arima(rmd, order= c(pmax-1,0,qmax-4))
mod7
```


* Modèle 8 : (p,q) = (1,5), ma5 n'est pas significatif.
```{r echo=FALSE, eval=FALSE}
mod8 <- arima(rmd, order= c(pmax-1,0,qmax-5))
mod8
```


* Modèle 9 : (p,q) = (1,4), ma4 n'est pas significatif.
```{r echo=FALSE, eval=FALSE}
mod9 <- arima(rmd, order= c(pmax-1,0,qmax-6))
mod9
```


* **Modèle 10 : (p,q) = (1,3), ar1 et ma4 sont significatifs.**
```{r echo=FALSE}
mod10 <- arima(rmd, order= c(1,0,3))
mod10
```


* Modèle 11 : (p,q) = (2,8), ma8 n'est pas significatif.
```{r echo=FALSE, eval=FALSE}
mod11 <- arima(rmd, order= c(pmax,0,qmax-2))
mod11
```


* Modèle 12 : (p,q) = (2,7), ma7 n'est pas significatif.
```{r echo=FALSE, eval=FALSE}
mod12 <- arima(rmd, order= c(pmax,0,qmax-3))
mod12
```


* Modèle 13 : (p,q) = (2,6), ma6 n'est pas significatif.
```{r echo=FALSE, eval=FALSE}
mod13 <- arima(rmd, order= c(pmax,0,qmax-4))
mod13
```


* Modèle 14 : (p,q) = (2,5), ma5 n'est pas significatif.
```{r echo=FALSE, eval=FALSE}
mod14 <- arima(rmd, order= c(pmax,0,qmax-5))
mod14
```


* **Modèle 15 : (p,q) = (2,4), ar2 et ma4 sont significatifs.**
```{r echo=FALSE, warning=FALSE}
mod15 <- arima(rmd, order= c(2,0,4))
mod15
```


## Choix de modèle et vérification
* On garde les modèles **10** (1,3) et **15** (2,4), avec seulement des paramètres significatifs.

**Modèle 10 :**
```{r echo=FALSE}
mod10
```

**Modèle 15:**
```{r echo=FALSE, warning=FALSE}
mod15
```
Modèle 10 fournit un critère AIC, Log-vraisemblance et parcimonie (p+q) meilleurs que ceux du modèle 15.

--------------

### Vérification des hypothèses sur les résidus    
On fait des test pour vérifier l'absence de corrélation (Box-Pierce) et la normalité des résidus (Jarque-Bera et Kolmogorof-Smirnov).   


* **Model 15**  
```{r echo=FALSE}
res15 <- mod15$residuals
plot(res15)
acf(res15)
```

```{r echo=FALSE}
Box.test(ts)
tseries::jarque.bera.test(res15)
ks.test(x = res15, y = "pnorm", alternative = "two.sided")
```



* **Model 10**  
```{r echo=FALSE}
res10 <- mod10$residuals
plot(res10)
acf(res10)
```

```{r echo=FALSE}
Box.test(res10,lag = 10, fitdf = 6, type = "Box-Pierce")
tseries::jarque.bera.test(res10)
ks.test(x = res10, y = "pnorm", alternative = "two.sided")
```



